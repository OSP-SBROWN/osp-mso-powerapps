ComponentDefinitions:
  Func_RefreshHierarchy:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      OnReset: |-
        =Set(AppStatusColour,TPT_Loading);
        Set(AppStatusText,"Fetching Hierarchy Details from SQL");

        With({SQL: s.tidyHierManGetFullHierarchyCurrent({MacroDate:RVA_MacroSpaceDate})}, 
            Set(AppStatusText,SQL.OutputParameters.SQL_Message);
            If(SQL.OutputParameters.SQL_Success, 
                Set(AppStatusColour,TPT_SuccessCol);
                ClearCollect(Col_Hierarchy,SQL.ResultSets.Table1);
                ClearCollect(Col_Hier1,SQL.ResultSets.Table3);
                ClearCollect(Col_Hier2,SQL.ResultSets.Table4);
                ClearCollect(Col_Hier3,SQL.ResultSets.Table5);
                ClearCollect(Col_H3List_NotInHierarchy, SQL.ResultSets.Table2), 

                Set(AppStatusColour, TPT_ErrorCol)
            )
        )

ComponentDefinitions:
  Func_FetchHierarchy:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Height: =150
      OnReset: |-
        =With({SQL:s.tidyHierMan2GetFullHierarchy({Hier_Version:Sel_HierarchyVersion_ID})},
            If(SQL.OutputParameters.SQL_Success=true, 
            Clear(Col_HierarchyFull);
            Clear(Col_Hier1);
            Clear(Col_Hier2);
            Clear(Col_Hier3);

            ClearCollect(Col_HierarchyFull,SQL.ResultSets.Table1);
            ClearCollect(Col_Hier1,SQL.ResultSets.Table2);
            ClearCollect(Col_Hier2,SQL.ResultSets.Table3);
            ClearCollect(Col_Hier3,SQL.ResultSets.Table4)
            ));
      Width: =150


ComponentDefinitions:
  Func_GetH1Details:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Fill: =RGBA(166, 215, 153, 1)
      Height: =150
      OnReset: |-
        =With({SQL:s.tidyHierMan2GetHierarchy1Details({
            HierarchyVersion_ID:Sel_HierarchyVersion_ID,
            Hierarchy1_ID:Gly_H1.Selected.Hierarchy1_ID})}, 
            Set(StatusText, SQL.OutputParameters.SQL_Message);
            Set(StatusColour, If(SQL.OutputParameters.SQL_Success,ColPal_Green,ColPal_Red));
            If(SQL.OutputParameters.SQL_Success, Set(SelectedH1_Details, SQL.OutputParameters)))
      Width: =150


ComponentDefinitions:
  Func_GetH2Details:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Fill: =RGBA(166, 215, 153, 1)
      Height: =150
      OnReset: |-
        =With({SQL:s.tidyHierMan2GetHierarchy2Details({
            HierarchyVersion_ID:Sel_HierarchyVersion_ID,
            Hierarchy2_ID:Gly_H2.Selected.Hierarchy2_ID})}, 
            Set(StatusText, SQL.OutputParameters.SQL_Message);
            Set(StatusColour, If(SQL.OutputParameters.SQL_Success,ColPal_Green,ColPal_Red));
            If(SQL.OutputParameters.SQL_Success, Set(SelectedH2_Details, SQL.OutputParameters)))
      Width: =150


ComponentDefinitions:
  Func_GetH3Details:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Fill: =RGBA(45, 128, 40, 1)
      Height: =150
      OnReset: |-
        =With({SQL:s.tidyHierMan2GetHierarchy3Details({
            HierarchyVersion_ID:Sel_HierarchyVersion_ID,
                Hierarchy3_ID: Gly_H3.Selected.Hierarchy3_ID})},
            Set(
                StatusText,
                SQL.OutputParameters.SQL_Message
            );
            Set(
                StatusColour,
                If(
                    SQL.OutputParameters.SQL_Success,
                    ColPal_Green,
                    ColPal_Red
                )
            );
            If(
                SQL.OutputParameters.SQL_Success,
                Set(
                    SelectedH3_Details,
                    SQL.OutputParameters
                )
            )
        )
      Width: =150


ComponentDefinitions:
  Func_UpdateH1:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Fill: =RGBA(39, 113, 194, 1)
      Height: =150
      OnReset: |-
        =Set(
            SelectedH1_Details, Patch(SelectedH1_Details, {
                Hierarchy1_Name: TxtIn_H1Edit_Name.Value,
                Hierarchy1_Code: TxtIn_H1Edit_Code.Value,
                MinBays: NumIn_H1Edit_MinBays.Value,
                MaxBays: NumIn_H1Edit_MaxBays.Value,
                BayRoundingThreshold: NumIn_H1Edit_BRT.Value,
                DOS: NumIn_H1Edit_DOSTarget.Value,
                COS: NumIn_H1Edit_COSTarget.Value,
                Trend: NumIn_H1Edit_Trend.Value
            })
        );

        With({SQL: s.tidyHierMan2Update1({
                Hierarchy1_ID:SelectedH1.ID,
                BayRoundingThreshold:SelectedH1_Details.BayRoundingThreshold,
                COS:SelectedH1_Details.COS,
                DOS: SelectedH1_Details.DOS,
                Exclude_From_Analysis:SelectedH1_Details.Exclude_From_Analysis, 
                Hierarchy1_Code:SelectedH1_Details.Hierarchy1_Code,
                Hierarchy1_Name:SelectedH1_Details.Hierarchy1_Name,
                MaxBays:SelectedH1_Details.MaxBays,
                MinBays:SelectedH1_Details.MinBays,
                Trend:SelectedH1_Details.Trend})}, 

                    If(SQL.OutputParameters.SQL_Success, 
                        Set(StatusColour,ColPal_Green), 
                        Set(StatusColour, ColPal_Red));
                    Set(StatusText,SQL.OutputParameters.SQL_Message)
        )
      Width: =150


ComponentDefinitions:
  Func_DeleteH1:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Fill: =RGBA(255, 191, 0, 1)
      Height: =150
      OnReset: "=With(\r\n    {SQL:s.tidyHierMan2Delete1({\r\n        HierarchyVersion_ID:Sel_HierarchyVersion_ID,\r\n        Hier1_ID:Gly_H1.Selected.Hierarchy1_ID}\r\n    )}, \r\n\r\nSet(\r\n    StatusColour,\r\n        If(\r\n            SQL.OutputParameters.SQL_Success=true, \r\n                ColPal_Green,\r\n                ColPal_Red)\r\n                \r\n);\r\nSet(StatusText,SQL.OutputParameters.SQL_Message)\r\n);\r\nSet(Vis_Modal_DeleteH1,false);\r\nSet(Vis_ModalGlobal_Main,false);\r\nIf(StatusColour=ColPal_Red,false,Reset(Func_FetchHierarchy_1));"
      Width: =150


ComponentDefinitions:
  Func_GetHierarchyVersions:
    DefinitionType: CanvasComponent
    AccessAppScope: true
    Properties:
      Fill: =RGBA(15, 108, 189, 1)
      Height: =150
      OnReset: |-
        =With(
            {SQL: s.tidyHierMan2GetAllVersions()},
            Set(
                StatusText,
                SQL.OutputParameters.SQL_Message
            );
            Set(
                StatusColour,
                If(
                    SQL.OutputParameters.SQL_Success = 1,
                    ColPal_Green,
                    ColPal_Red
                )
            );
            If(
                SQL.OutputParameters.SQL_Success,
                ClearCollect(
                    Col_HierarchyVersions,
                    SQL.ResultSets.Table1
                )
            )
        )
      Width: =150
